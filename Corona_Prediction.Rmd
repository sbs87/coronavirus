---
title: "Corona_Case_Prediction"
author: "Steven Smith, PhD"
date: "3/18/2020"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
last_updated: 3/24/2020
---

# The 2019-2020 Coronavirus Pandemic Analysis
## BACKGROUND & APPROACH
I wanted to track and trend the coronavirus outbreak on my own curiosity. There are some interesting questions that may fall out of this, as it is a very historic moment, including scientifically and analytically (we have a large amount of data being shared across the globe, analyzed in real-time). The world has come to a halt because of it.  
This analysis attempts to answer the following questions (more to come):
1. What does the trend of the pandemic look like to date?  
2. What are future case predictions based on historical model?
3. What interesting quirks or patterns emerge? 


ASSUMPTIONS & LIMITATIONS: 
* This data is limited by the source. I realized early on that depending on source there were conflicting # of cases. Originally I was using JHU data... but this was always 'ahead' of the Our World In Data. I noticed that JHU's website was buggy- you clicked on the U.S. stats but it didn't reflect the U.S.. So I changed data sources to be more consistent with what is presented in the media (and Our World In Data has more extensive plots I can compare my own to). An interesting aside might be why the discrepancy? Was I missing something?  
* Defintiions are important as is the idea that multiple varibales accumulate in things like total cases (more testing for example).  

SOURCE RAW DATA: https://ourworldindata.org/coronavirus
INPUT DATA LOCATION: github (https://github.com/sbs87coronavirus/data)
OUTPUT DATA LOCATIOn: github (https://github.com/sbs87coronavirus/results)

## PRE-ANALYSIS
The following sections are outside the scope of the 'analysis' but are still needed to prepare everything

### UPSTREAM PROCESSING/ANALYSIS (N/A)
Not applicable - No analysis performed on remote server

```{bash process_remote_server, eval=F}
# No analysis performed on remote server

```

### SET UP ENVIORNMENT
Load libraries and set global variables
```{r setup, eval=T}

# clear previous enviornment
rm(list = ls())

##------------------------------------------
## LIBRARIES
##------------------------------------------
library(ggplot2)
library(tidyverse)
library(plyr)
library(reshape2)
library(plot.utils)
library(utils)

##------------------------------------------

##------------------------------------------
# GLOBAL VARIABLES
##------------------------------------------
user_name<-Sys.info()["user"]
working_dir<-paste0("/Users/",user_name,"/Projects/coronavirus/") # don't forget trailing /
results_dir<-paste0(working_dir,"results/") # assumes diretory exists
results_dir_custom<-paste0(results_dir,"custom/") # assumes diretory exists
Corona_Cases.fn<-paste0(working_dir,"data/","time_series_covid19_confirmed_global.csv")
Corona_Cases.US.fn<-paste0(working_dir,"data/time_series_covid19_confirmed_US.csv")
Corona_Cases.source_url<-"https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"
Corona_Cases.US.source_url<-"https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv"
default_theme<-theme_bw()+theme(text = element_text(size = 14)) # fix this
##------------------------------------------

```
### FUNCTIONS
List of functions
1. Function 1  
2. Function 2  
```{r functions, eval=T}
##------------------------------------------
## FUNCTION: prediction_model
##------------------------------------------
## --- //// ----
# Takes days vs log10 (case) linear model parameters and a set of days since 100 cases and outputs a dataframe with total number of predicted cases for those days
## --- //// ----
prediction_model<-function(m=1,b=0,days=1){
  total_cases.log<-m*days+b
  total_cases<-10^total_cases.log
  prediction<-data.frame(Days_since_100=days,Total_confirmed_cases=total_cases,Total_confirmed_cases.log=total_cases.log)
  return(prediction)
}
##------------------------------------------

##------------------------------------------
## FUNCTION: make_long
##------------------------------------------
## --- //// ----
# Takes wide-format case data and converts into long format, using date and total cases as variable/values. Also enforces standardization/assumes data struture naming by using fixed variable name, value name, id.vars, 
## --- //// ----
make_long<-function(data_in,variable.name = "Date",
                   value.name = "Total_confirmed_cases",
                   id.vars=c("Province.State","Country.Region","Lat","Long","City")){

long_data<-melt(data_in,
                id.vars = id.vars,
                variable.name=variable.name,
                value.name=value.name)
return(long_data)
  
}
##------------------------------------------
```

### READ IN DATA
* total number of cases. current source: https://github.com/CSSEGISandData (precvious source https://ourworldindata.org/coronavirus)

```{r read_in_data, eval=T}
# Q: do we want to archive previous versions? Maybe an auto git mv? 

##------------------------------------------
## Download and read in latest data from github
##------------------------------------------
download.file(Corona_Cases.source_url,destfile = Corona_Cases.fn)
Corona_Cases.raw<-read.csv(Corona_Cases.fn,header = T,stringsAsFactors = F)

download.file(Corona_Cases.US.source_url,destfile = Corona_Cases.US.fn)
Corona_Cases.US.raw<-read.csv(Corona_Cases.US.fn,header = T,stringsAsFactors = F)

head(Corona_Cases.US.raw)
head(Corona_Cases.raw)

```


### PROCESS DATA
* Convert to long format  
* Fix date formatting/convert to numeric date  
* Log10 transform total # cases  

```{r process, eval=T}

##------------------------------------------
## Convert to long format
##------------------------------------------
#JHU has a gross file format. It's in wide format with each column is the date in MM/DD/YY. So read this in as raw data but trasnform it to be better suited for analysis
# Furthermore, the World and US level data is formatted differently, containing different columns, etc. Recitfy this and combine the world-level stats with U.S. level stats. 

# prepare raw datasets for eventual combining
Corona_Cases.raw$City<-"NA" # US-level data has Cities
Corona_Cases.US.raw$Country_Region<-"US_state" # To differentiate from World-level stats
filter(Corona_Cases.raw,Country.Region=="US")
Corona_Cases.US.raw<-rename(Corona_Cases.US.raw,c("Province_State"="Province.State",
                                                  "Country_Region"="Country.Region",
                                                  "Long_"="Long",
                                                  "Admin2"="City"))

Corona_Cases<-rbind(make_long(select(Corona_Cases.US.raw,-c(UID,iso2,iso3,code3,FIPS,Combined_Key))),
make_long(Corona_Cases.raw))


##------------------------------------------
## Fix date formatting, convert to numeric date
##------------------------------------------
Corona_Cases$Date<-gsub(Corona_Cases$Date,pattern = "^X",replacement = "0") # leading 0 read in as X
Corona_Cases$Date<-gsub(Corona_Cases$Date,pattern = "20$",replacement = "2020") # ends in .20 and not 2020
Corona_Cases$Date<-as.Date(Corona_Cases$Date,format = "%m.%d.%y")
Corona_Cases$Date.numeric<-as.numeric(Corona_Cases$Date)
filter(Corona_Cases,Country.Region=="US")
##------------------------------------------
## log10 transform total # cases
##------------------------------------------
Corona_Cases$Total_confirmed_cases.log<-log(Corona_Cases$Total_confirmed_cases,10)
##------------------------------------------

##------------------------------------------
## Compute # of days since 100th for US data
##------------------------------------------

# Find day that 100th case was found for Country/Province. NOTE: Non US countries may have weird provinces. For example, Frane is summairzed at the country level but also had 3 providences. I've only ensured the U.S. case100 works... so the case100_date for U.S. is summarized both for the entire country (regardless of state) and on a per-state level. 
# TODO: consider city-level summary as well. This data may be sparse

Corona_Cases<-merge(Corona_Cases,ddply(filter(Corona_Cases,Total_confirmed_cases>100),c("Country.Region","Province.State"),summarise,case100_date=min(Date.numeric)))
Corona_Cases$Days_since_100<-Corona_Cases$Date.numeric-Corona_Cases$case100_date

# Filter df for US state-wide stats
Corona_Cases.US<-filter(Corona_Cases,Country.Region=="US_state" & Total_confirmed_cases>0)

# Preview
head(Corona_Cases)
head(Corona_Cases.US)


##------------------------------------------
## Plot confirmed cases per state (custom)
##------------------------------------------


Corona_Cases.US.plotdata<-filter(Corona_Cases.US,Province.State %in% c("Pennsylvania","Maryland","New York","New Jersey") & City %in% c("Bucks","Baltimore City", "New York","Burlington")) 

(Corona_Cases.US.log.plot<-ggplot(Corona_Cases.US.plotdata,aes(x=Date,y=Total_confirmed_cases.log,col=City))+
  geom_point(size=4)+
    geom_line()+
  default_theme+
  #facet_wrap(~Province.State,scales = "free_y")
theme(legend.position = "bottom"))

(Corona_Cases.US.plot<-ggplot(Corona_Cases.US.plotdata,aes(x=Date,y=Total_confirmed_cases,col=City))+
  geom_point(size=4)+
    geom_line()+
  default_theme+
  facet_wrap(~Province.State,scales = "free_y")+
theme(legend.position = "bottom"))

filter(Corona_Cases.US,Province.State %in% c("Pennsylvania") & Date=="2020-03-30") %>% arrange(Total_confirmed_cases.log)

write_plot(Corona_Cases.US.log.plot,wd=results_dir_custom)
write_plot(Corona_Cases.US.plot,wd=results_dir_custom)
```
## ANALYSIS
 
### Q1: What is the trend in total cases?
Plot # of cases vs time (US only)
FUTURE: compare different countries
```{r question1, eval=T}
##------------------------------------------
## Linear model for days since 100 cases vs log10(confirmed cases)
##------------------------------------------

Corona_Cases.US<-filter(Corona_Cases,Country.Region=="US" & Total_confirmed_cases>0)
Corona_Cases.US.case100<-filter(Corona_Cases.US, Days_since_100>=0)
# linear model parameters
(model_fit<-lm(formula = Total_confirmed_cases.log~Days_since_100,data= Corona_Cases.US.case100 ))
N<-ddply(filter(Corona_Cases,Total_confirmed_cases>100),c("Country.Region"),summarise,n=length(Country.Region))
#ddply(filter(Corona_Cases,Total_confirmed_cases>100 & Country.Region %in% N[N$Country.Region>2,"Country.Region"]),c("Country.Region"), summarise,data.frame(lm(formula = Total_confirmed_cases.log~Days_since_100)$coefficients))

(slope<-model_fit$coefficients[2])
(intercept<-model_fit$coefficients[1])

# Correlation coefficient
cor(x = Corona_Cases.US.case100$Days_since_100,y = Corona_Cases.US.case100$Total_confirmed_cases.log)


(Corona_Cases.US.plot<-ggplot(Corona_Cases.US,aes(x=Days_since_100,y=Total_confirmed_cases))+
  default_theme+
  geom_point())

(Corona_Cases.US.log.plot<-ggplot(Corona_Cases.US,aes(x=Days_since_100,y=Total_confirmed_cases.log))+
  geom_abline(slope = slope,intercept = intercept,lty=2)+
   default_theme+
  geom_point())

write_plot(Corona_Cases.US.plot,wd = results_dir)
write_plot(Corona_Cases.US.log.plot,wd = results_dir)

```
### Q2: What is the predicted number of cases?

# What is the prediction of COVID-19 based on model thus far?
Additional questions:

WHy did it take to day 40 to start a log linear trend?
How long will it be till x number of cases?
When will the plateu happen?
Are any effects noticed with social distancing? Delays
```{r prediction, eval=T}

##------------------------------------------
## Prediction and Prediction Accuracy
##------------------------------------------

# What is the predict # of cases for the next few days?
# How is the model performing historically?

# Formula for # of cases by x days
paste0("log10_total_cases = ",slope,"*days + ",intercept)
paste0("total_cases = 10^(",slope,"*days + ",intercept,")")
#Days untill... cases:
# 2.5k, 5k and 1M:
paste0("2.5k cases is ",(log(2.5E5,10) - intercept)/slope," days")
paste0("5k cases is ",(log(5E5,10)- intercept)/slope," days")
paste0("1M cases is ",(log(1E6,10)- intercept)/slope," days")

head(filter(Corona_Cases.raw,Country.Region=="US"))
today_num<-max(Corona_Cases.US$Days_since_100)
predicted_days<-today_num+c(1,2,3,7)

#mods = dlply(mydf, .(x3), lm, formula = y ~ x1 + x2)
#today:
Corona_Cases.US[Corona_Cases.US$Days_since_100==(today_num-1),]
Corona_Cases.US[Corona_Cases.US$Days_since_100==today_num,]
Corona_Cases.US$type<-"Historical"
names(Corona_Cases)

Corona_Cases_wprediction<-rbind.fill(Corona_Cases.US,data.frame(Code="USA",type="MAR26_prediction",prediction_model(m=slope,b=intercept,days = predicted_days)))

Corona_Cases.US.prediction<-Corona_Cases_wprediction 
prediction_values<-prediction_model(m=slope,b=intercept,days = predicted_days)$Total_confirmed_cases

histoical_model<-data.frame(date=today_num,m=slope,b=intercept)

# model for previous y days
historical_model_predictions<-data.frame(day_x=NULL,Days_since_100=NULL,Total_confirmed_cases=NULL,Total_confirmed_cases.log=NULL)
for(i in c(1,2,3,4,5,6,7,8,9,10)){
  #i<-1
day_x<-today_num-i # 1, 2, 3, 4
day_x_nextweek<-day_x+c(1,2,3)
model_fit_x<-lm(data = filter(Corona_Cases.US.case100,Days_since_100 < day_x),formula = Total_confirmed_cases.log~Days_since_100)
prediction_day_x_nextweek<-prediction_model(m = model_fit_x$coefficients[2],b = model_fit_x$coefficients[1],days = day_x_nextweek)
prediction_day_x_nextweek$type<-"Predicted"
acutal_day_x_nextweek<-filter(Corona_Cases.US,Days_since_100 %in% day_x_nextweek) %>% select(c(Days_since_100,Total_confirmed_cases,Total_confirmed_cases.log))
acutal_day_x_nextweek$type<-"Historical"
historical_model_predictions.i<-data.frame(day_x=day_x,rbind(acutal_day_x_nextweek,prediction_day_x_nextweek))
historical_model_predictions<-rbind(historical_model_predictions.i,historical_model_predictions)
}

historical_model_predictions.withHx<-rbind.fill(historical_model_predictions,data.frame(Corona_Cases.US,type="Historical"))
historical_model_predictions.withHx$Total_confirmed_cases.log2<-log(historical_model_predictions.withHx$Total_confirmed_cases,2)

(historical_model_predictions.plot<-ggplot(historical_model_predictions.withHx,aes(x=Days_since_100,y=Total_confirmed_cases.log,col=type))+
    geom_point(size=3)+
    default_theme+
    theme(legend.position = "bottom")+ 
      #geom_abline(slope = slope,intercept =intercept,lty=2)+
    scale_color_manual(values = c("Historical"="#377eb8","Predicted"="#e41a1c")))
write_plot(historical_model_predictions.plot,wd=results_dir)
```


```{r question2, eval=F}

##------------------------------------------
## filter input_data1
##------------------------------------------
input_data1.filter<-fitler(input_data1,col1=="foo")
##------------------------------------------

##------------------------------------------
## sub question 1
##------------------------------------------
table(input_data1.filter$col<5)
##------------------------------------------

##------------------------------------------
## sub question 2
##------------------------------------------
table(input_data1.filter$col<10)
##------------------------------------------

##------------------------------------------
## plot data
##------------------------------------------
(input_data1.filter.plot<-ggplot(input_data1.filter,aes(x=col1,y=col2.log))+
   geom_point()+
   default_plot_theme)
write_plot(input_data1.filter.plot,wd=results_dir)
##------------------------------------------
results_dir
```
# CONCLUSION
A concluding remark(s) on the major findings, preferabbly to pointers where the data can be found. 

Helps to have a bullet point for each analysis chunk or an answer to each of the above 'questions':
*  Answer 1. 
*  Answer 2.  

#END
Cheatsheet:
http://rmarkdown.rstudio.com>
# TODO
* mkdir the results dir if it doesn't exist
* make ggplot a dependency for plot.utils?
* automated way of downloading daily data
* fix plot_utils, add dataset and documentation
* Auto git mv the new data?

# Sandbox

```{r eval=F}
##TODO:
# Geographical heatmap!
ggplot(data = Corona_Cases) +
    geom_sf()

reportTimeStamp = format(Sys.time(), "%Y-%m-%d (%a) %X")
titleStr        = paste("COVID-19 Deaths by Country/Region ", "[", reportTimeStamp, "]", sep="")

# add projections for Bucks County, Burlington County and Baltimore City , NYC




```
