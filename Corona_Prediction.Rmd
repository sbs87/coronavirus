---
title: "Corona_Case_Prediction"
author: "Steven Smith, PhD"
date: "3/18/2020"
last_updated: "3/24/2020"
output: 
  html_document: 
    toc: yes
---

# The 2019-2020 Coronavirus Pandemic Analysis
## BACKGROUND & APPROACH
I wanted to track and trend the coronavirus outbreak on my own curiosity. There are some interesting questions that may fall out of this, as it is a very historic moment, including scientifically and analytically (we have a large amount of data being shared across the globe, analyzed in real-time). The world has come to a halt because of it.  
This analysis attempts to answer the following questions (more to come):
1. What does the trend of the pandemic look like to date?  
2. What are future case predictions based on historical model?
3. What interesting quirks or patterns emerge? 


ASSUMPTIONS & LIMITATIONS: 
* This data is limited by the source. I realized early on that depending on source there were conflicting # of cases. Originally I was using JHU data... but this was always 'ahead' of the Our World In Data. I noticed that JHU's website was buggy- you clicked on the U.S. stats but it didn't reflect the U.S.. So I changed data sources to be more consistent with what is presented in the media (and Our World In Data has more extensive plots I can compare my own to). An interesting aside might be why the discrepancy? Was I missing something?  
* Defintiions are important as is the idea that multiple varibales accumulate in things like total cases (more testing for example).  

SOURCE RAW DATA: https://ourworldindata.org/coronavirus
INPUT DATA LOCATION: github (https://github.com/sbs87coronavirus/data)
OUTPUT DATA LOCATIOn: github (https://github.com/sbs87coronavirus/results)

## PRE-ANALYSIS
The following sections are outside the scope of the 'analysis' but are still needed to prepare everything

### UPSTREAM PROCESSING/ANALYSIS (N/A)
Not applicable - No analysis performed on remote server

```{bash process_remote_server, eval=F}
# No analysis performed on remote server

```

### SET UP ENVIORNMENT
Load libraries and set global variables
```{r setup, eval=T}

# clear previous enviornment
rm(list = ls())

##------------------------------------------
## LIBRARIES
##------------------------------------------
library(ggplot2)
library(tidyverse)
library(plyr)
library(reshape2)
library(plot.utils)
#library(lubridate)
library(utils)

##------------------------------------------

##------------------------------------------
# GLOBAL VARIABLES
##------------------------------------------
working_dir<-"/Users/stevensmith/Projects/coronavirus/" # don't forget trailing /
results_dir<-paste0(working_dir,"results/") # assumes diretory exists
Corona_Cases.fn<-paste0(working_dir,"data/","total-cases-covid-19.csv") 
Corona_Cases.source_url<-"https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"
default_theme<-theme_bw()+theme(text = element_text(size = 14)) # fix this
##------------------------------------------

```
### FUNCTIONS
List of functions
1. Function 1  
2. Function 2  
```{r functions, eval=T}
##------------------------------------------
## FUNCTION: prediction_model
##------------------------------------------
## --- //// ----
# Takes days vs log10 (case) linear model parameters and a set of days since 100 cases and outputs a dataframe with total number of predicted cases for those days
## --- //// ----
prediction_model<-function(m=1,b=0,days=1){
  total_cases.log<-m*days+b
  total_cases<-10^total_cases.log
  prediction<-data.frame(Days_since_100=days,Total_confirmed_cases=total_cases,Total_confirmed_cases.log=total_cases.log)
  return(prediction)
}
##------------------------------------------
```

### READ IN DATA
* total number of cases. current source: https://github.com/CSSEGISandData (precvious source https://ourworldindata.org/coronavirus)

```{r read_in_data, eval=T}
# Q: do we want to archive previous versions? Maybe an auto git mv? 

##------------------------------------------
## Download and read in latest data from github
##------------------------------------------
download.file(Corona_Cases.source_url,destfile = Corona_Cases.fn)
Corona_Cases.raw<-read.csv(Corona_Cases.fn,header = T,stringsAsFactors = F)

```


### PROCESS DATA
* Convert to long format  
* Fix date formatting/convert to numeric date  
* Log10 transform total # cases  

```{r process, eval=T}

##------------------------------------------
## Convert to long format
##------------------------------------------
#JHU has a gross file format. It's in wide format with each column is the date in MM/DD/YY. So read this in as raw data but trasnform it to be better suited for analysis
head(Corona_Cases.raw)

Corona_Cases<-melt(Corona_Cases.raw,
                   id.vars = c("Province.State","Country.Region","Lat","Long"),
                   variable.name = "Date",
                   value.name = "Total_confirmed_cases")

##------------------------------------------
## Fix date formatting, convert to numeric date
##------------------------------------------
Corona_Cases$Date<-gsub(Corona_Cases$Date,pattern = "^X",replacement = "0") # leading 0 read in as X
Corona_Cases$Date<-as.Date(Corona_Cases$Date,format = "%m.%d.%y")
Corona_Cases$Date.numeric<-as.numeric(Corona_Cases$Date)


##------------------------------------------
## log10 transform total # cases
##------------------------------------------
Corona_Cases$Total_confirmed_cases.log<-log(Corona_Cases$Total_confirmed_cases,10)
##------------------------------------------


##------------------------------------------
## Compute # of days since 100th for US data
##------------------------------------------
# TODO: do for all countries
Corona_Cases.US<-filter(Corona_Cases,Country.Region=="US" & Total_confirmed_cases>0)
case100_date<-min(Corona_Cases.US[Corona_Cases.US$Total_confirmed_cases>100,"Date.numeric"])
Corona_Cases.US$Days_since_100<-Corona_Cases.US$Date.numeric-case100_date

# Filter df for 
Corona_Cases.US.case100<-filter(Corona_Cases.US,Days_since_100>0)

# Preview
head(Corona_Cases)
head(Corona_Cases.US)

```
## ANALYSIS
 
### Q1: What is the trend in total cases?
Plot # of cases vs time (US only)
FUTURE: compare different countries
```{r question1, eval=T}
##------------------------------------------
## Linear model for days since 100 cases vs log10(confirmed cases)
##------------------------------------------

# linear model parameters
(model_fit<-lm(formula = Total_confirmed_cases.log~Days_since_100,data= Corona_Cases.US.case100 ))
(slope<-model_fit$coefficients[2])
(intercept<-model_fit$coefficients[1])

# Correlation coefficient
cor(x = Corona_Cases.US.case100$Days_since_100,y = Corona_Cases.US.case100$Total_confirmed_cases.log)


(total_cases.25.plot<-ggplot(Corona_Cases.US,aes(x=Days_since_100,y=Total_confirmed_cases))+
  default_theme+
  geom_point())

(total_cases.25.log.plot<-ggplot(Corona_Cases.US,aes(x=Days_since_100,y=Total_confirmed_cases.log))+
  geom_abline(slope = slope,intercept = intercept,lty=2)+
   default_theme+
  geom_point())
total_cases.25.log.plot+xlim(c(15,25))
write_plot(total_cases.25.plot,wd = results_dir)
write_plot(total_cases.25.log.plot,wd = results_dir)



```
### Q2: What is the predicted number of cases?


# What is the prediction of COVID-19 based on model thus far?
Additional questions:

WHy did it take to day 40 to start a log linear trend?
How long will it be till x number of cases?
When will the plateu happen?
Are any effects noticed with social distancing? Delays
```{r prediction, eval=T}
# Formula for # of cases by x days
paste0("log10_total_cases = ",slope,"*days + ",intercept)
paste0("total_cases = 10^(",slope,"*days + ",intercept,")")
#Days untill... cases:
# 2.5k, 5k and 1M:
paste0("2.5k cases is ",(log(2.5E5,10) - intercept)/slope," days")
paste0("5k cases is ",(log(5E5,10)- intercept)/slope," days")
paste0("1M cases is ",(log(1E6,10)- intercept)/slope," days")


today_num<-max(Corona_Cases.US$Days_since_100)
predicted_days<-today_num+c(1,2,3,7)


#today:
Corona_Cases.US[Corona_Cases.US$Days_since_100==(today-1),]
Corona_Cases.US[Corona_Cases.US$Days_since_100==today,]
prediction_model(m = slope,b=intercept,days=predicted_days)
Corona_Cases.US$type<-"Historical"
names(Corona_Cases)

Corona_Cases_wprediction<-rbind.fill(Corona_Cases.US,data.frame(Code="USA",type="MAR26_prediction",prediction_model(m=slope,b=intercept,days = predicted_days)))

Corona_Cases.US.prediction<-Corona_Cases_wprediction #filter(Corona_Cases_wprediction,Code=="USA" )
prediction_values<-prediction_model(m=slope,b=intercept,days = predicted_days)$Total_confirmed_cases

mar26_prediction<-data.frame(type="MAR26_prediction",Days_since_100=predicted_days-7,Total_confirmed_cases.log=log(prediction_values,10),text_display=paste0(c("tomorrow : ","two_days: ","three_days: ","next_week: "),round(prediction_values,digits = 0)))
mar25_prediction<-data.frame(type="MAR25_prediction",Days_since_100=predicted_days-20,Total_confirmed_cases.log=log(c(56490.42,75400.32,100640.22,319422.18),10),text_display=paste0(c("today's (actual=55231): ","tomorrow: ","two_days: ","6 days: "),round(c(56490.42,75400.32,100640.22,319422.18),digits = 0)))
              
(predicted.25.plot<-ggplot(Corona_Cases.US.prediction,aes(x=Days_since_100,y=Total_confirmed_cases.log,col=type))+
    geom_abline(slope = slope,intercept = intercept,lty=2)+
  #geom_vline(xintercept = c(key_milestones.days),lty=2)+
  geom_point(size=3)+
default_theme+
  ylab("log10 Total U.S. Cases")+
  xlab("Days since X")+
  theme(legend.position = "bottom")+
    geom_text(data = mar25_prediction,aes(label=text_display))+
        geom_text(data = mar26_prediction,aes(label=text_display))+
  scale_color_manual(values = c("Historical"="#377eb8","MAR25_prediction"="orange","MAR26_prediction"="#e41a1c")))
  
write_plot(predicted.25.plot,wd = results_dir)

```


```{r question2, eval=F}

##------------------------------------------
## filter input_data1
##------------------------------------------
input_data1.filter<-fitler(input_data1,col1=="foo")
##------------------------------------------

##------------------------------------------
## sub question 1
##------------------------------------------
table(input_data1.filter$col<5)
##------------------------------------------

##------------------------------------------
## sub question 2
##------------------------------------------
table(input_data1.filter$col<10)
##------------------------------------------

##------------------------------------------
## plot data
##------------------------------------------
(input_data1.filter.plot<-ggplot(input_data1.filter,aes(x=col1,y=col2.log))+
   geom_point()+
   default_plot_theme)
write_plot(input_data1.filter.plot,wd=results_dir)
##------------------------------------------

```
# CONCLUSION
A concluding remark(s) on the major findings, preferabbly to pointers where the data can be found. 

Helps to have a bullet point for each analysis chunk or an answer to each of the above 'questions':
*  Answer 1. 
*  Answer 2.  

#END
Cheatsheet:
http://rmarkdown.rstudio.com>
# TODO
* mkdir the results dir if it doesn't exist
* make ggplot a dependency for plot.utils?
* automated way of downloading daily data
* fix plot_utils, add dataset and documentation
* Auto git mv the new data?

# Sandbox

```{r eval=F}
# Store histroical preidctions
# maybe just store the model parameters, then re-compute for a given model and series of dates!!

# ok..

#datastructure:
#-date (or ID)
#-slope
#-intercept

#re-use function that takes m, b, dates and computes estimates

# assumptions: same linear model.

#latiernative- filter inputdaya set to n-1 days

histoical_model<-data.frame(date=today,m=slope,b=intercept)


today_num
# model for previous y days
historical_model_predictions<-data.frame(day_x=NULL,Days_since_100=NULL,Total_confirmed_cases=NULL,Total_confirmed_cases.log=NULL)
for(i in c(1,2,3,4,5)){
day_x<-today_num-i # 1, 2, 3, 4
day_x_nextweek<-day_x+c(1,2,3,7)
model_fit_x<-lm(data = filter(Corona_Cases.US.case100,Days_since_100 < day_x),formula = Total_confirmed_cases.log~Days_since_100)

historical_model_predictions<-rbind.fill(historical_model_predictions,merge(filter(Corona_Cases.US.case100,Days_since_100==day_x),data.frame(day_x=day_x,prediction_model(m = model_fit_x$coefficients[2],b = model_fit_x$coefficients[1],days = day_x_nextweek))))
}
ggplot(historical_model_predictions)+geom_point(aes(x=Days_since_100,y=Total_confirmed_cases,col=as.factor(day_x)))

# TODO add actual call to plot

reportTimeStamp = format(Sys.time(), "%Y-%m-%d (%a) %X")
titleStr        = paste("COVID-19 Deaths by Country/Region ", "[", reportTimeStamp, "]", sep="")

```
